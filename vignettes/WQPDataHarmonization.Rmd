---
title: "WQP Data Harmonization"
author: "Cristina Mullin"
date: "May 1, 2022"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{WQP Data Harmonization}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---
```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

## Load TADA library and update internal TADA package validation and reference tables
```{r}
# look into using install_github(); library() only works for CRAN packages
library(TADA)
UpdateWQXCharValRef()
UpdateMeasureUnitRef()
```

## Read in WQP data using WQP web services directly 

Go to the WQP website (https://www.waterqualitydata.us/) and fill out the 
query form. Choose the Full Physical Chemical Data Profile, all data sources, 
and the file format Comma-Separated. Do not hit the download button. Instead, 
copy the web service URL located at the bottom of the page under "Result". 

Use that "Result" web service URL as the input for this function to download data 
directly into R.  

Here are two "Result" web service examples: 

CT Nutrient Group: https://www.waterqualitydata.us/data/Result/search?statecode=US%3A09&countycode=US%3A09%3A003&characteristicType=Nutrient&mimeType=csv&zip=yes&dataProfile=resultPhysChem&providers=NWIS&providers=STEWARDS&providers=STORET

PA Nutrient Group: https://www.waterqualitydata.us/data/Result/search?statecode=US%3A42&characteristicType=Nutrient&mimeType=csv&zip=yes&dataProfile=resultPhysChem&providers=NWIS&providers=STEWARDS&providers=STORET

Note: It may be useful to save the Query URL as well as a comment within 
your code. This URL let's you return to the WQP query page with all your 
original data filters, but it cannot be used to download the data.

WQP query URL: https://www.waterqualitydata.us/#statecode=US%3A42&characteristicType=Nutrient&mimeType=csv&dataProfile=resultPhysChem&providers=NWIS&providers=STEWARDS&providers=STORET

## Clean raw data for TADA use case
```{r}
#Get testing data
  #stateCode = "US:24",
  #siteType = c("Lake, Reservoir, Impoundment", "Stream")
  #sampleMedia = c("water", "Water")
  #characteristicName = c("Ammonia", "Nitrate", "Nitrogen")
  #startDate = "01-01-2019"
  #endDate = "01-01-2022"
TADAProfileRaw=TADAdataRetrieval()

#Run all dependencies
TADAProfileClean=MeasureValueSpecialCharacters(TADAProfileRaw)
#runs as part of retrieval: TADAProfileClean1=autoclean(TADAProfileClean)
TADAProfileClean2=DepthProfileData(TADAProfileClean)
TADAProfileClean3=AggregatedContinuousData(TADAProfileClean2)
TADAProfileClean4=WQXTargetUnits(TADAProfileClean3)
```

## Run result flag functions and address flagged data
```{r}
TADAProfileClean5=InvalidMethod(TADAProfileClean4)
TADAProfileClean6=PotentialDuplicateRowID(TADAProfileClean5)
TADAProfileClean7=AboveNationalWQXUpperThreshold(TADAProfileClean6)
TADAProfileClean8=BelowNationalWQXUpperThreshold(TADAProfileClean7)
TADAProfileClean9=QAPPapproved(TADAProfileClean8)
TADAProfileClean10=QAPPDocAvailable(TADAProfileClean8)
TADAProfileClean11=InvalidCoordinates(TADAProfileClean8)
TADAProfileClean12=InvalidFraction(TADAProfileClean8)
TADAProfileClean13=InvalidSpeciation(TADAProfileClean12)
TADAProfileClean14=InvalidResultUnit(TADAProfileClean13)
```

## Transform Characteristic, Speciation, and Unit values to TADA Standards
```{r}
UniqueHarmonizationRef=HarmonizationRefTable(TADAProfileClean14)
TADAProfileClean15=HarmonizeData(TADAProfileClean14, ref = UniqueHarmonizationRef)
```

---
title: "WQP Data Harmonization"
author: "Cristina Mullin and Jake Greif"
date: "May 1, 2022"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{WQP Data Harmonization}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---
```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

##Install packages 
If needed, install the following dependency package(s):
```{r}
install.packages("dataRetrieval")
remotes::install_github("USGS-R/dataRetrieval")
install.packages("dplyr")
install.packages("ggplot2")
install.packages("plyr")
install.packages("RColorBrewer")
install.packages("Rcpp")
install.packages("data.table")
install.packages("grDevices")
install.packages("magrittr")
install.packages("stringr")
install.packages("testthat")
install.packages("usethis")
install.packages("utils")
install.packages("stats")
install.packages("remotes")
```

##Load packages
```{r}
library("dataRetrieval")
library("plyr")
library("dplyr")
library("ggplot2")
library("RColorBrewer")
library("Rcpp")
library("data.table")
library("grDevices")
library("magrittr")
library("stringr")
library("testthat")
library("usethis")
library("utils")
library("stats")
library("remotes")
```

## Load TADA from GitHub
```{r}
# Use remotes package to install TADA from GitHub; library() only works for CRAN packages
remotes::install_github("USEPA/TADA")
```

## Retrieve WQP data and process it for compatibility with TADA
```{r}
#Get testing data
  #stateCode = "US:24",
  #siteType = c("Lake, Reservoir, Impoundment", "Stream")
  #sampleMedia = c("water", "Water")
  #characteristicName = c("Ammonia", "Nitrate", "Nitrogen")
  #startDate = "01-01-2019"
  #endDate = "01-01-2022"
#autocleans results upon retrieval (makes certain data uppercase, removes true duplicates, removes non-water media, cleans results with special characters)
TADATesting=TADAdataRetrieval()

#Edit and define your own query inputs below
#Enter ?TADAdataRetrieval in the console to read the documentation for this function
TADATesting2=TADAdataRetrieval(stateCode = "US:30", 
                              siteType = c("Lake, Reservoir, Impoundment", "Stream"),
                              sampleMedia = c("water", "Water"),
                              characteristicName = c("Ammonia", "Nitrate", "Nitrogen"),
                              startDate = "01-01-2019",
                              endDate = "01-01-2022")
```

```{r}
#converts all depth profile data to meters
TADAProfileClean2=DepthProfileData(TADATesting)
#check for and removes aggregrated continuous data, if present
TADAProfileClean3=AggregatedContinuousData(TADAProfileClean2)
#Converts all data to WQX target units
TADAProfileClean4=WQXTargetUnits(TADAProfileClean3)
```

## Run result flag functions and address flagged data
```{r}
TADAProfileClean5=InvalidMethod(TADAProfileClean4)
TADAProfileClean6=PotentialDuplicateRowID(TADAProfileClean5)
TADAProfileClean7=AboveNationalWQXUpperThreshold(TADAProfileClean6)
TADAProfileClean8=BelowNationalWQXUpperThreshold(TADAProfileClean7)
TADAProfileClean9=InvalidCoordinates(TADAProfileClean8)
TADAProfileClean10=InvalidFraction(TADAProfileClean9)
TADAProfileClean11=InvalidSpeciation(TADAProfileClean10)
TADAProfileClean12=InvalidResultUnit(TADAProfileClean11)
```

## Filter data by field
In this section a TADA user will want to review the unique values in specific fields and choose to remove particular values. 

To start, review the list of fields and the number of unique values in each field.
```{r, echo=FALSE}
FilterFields(TADAProfileClean12)
```

Next, choose a field from the list to see the unique values in that field, as well as the number of times each value appears in the dataset. We'll start with ActivityTypeCode.
```{r, echo=FALSE}
FilterFieldReview("ActivityTypeCode", TADAProfileClean12)
```

The ActivityTypeCode field has four unique values -- "Sample-Routine", "Quality Control Sample-Field Replicate", "Field Msr/Obs", and "Quality Control Sample-Field Blank." In this example we want to remove quality control values in the ActivityTypeCode field, therefore, we'll specify that we want to remove the "Quality Control Sample-Field Replicate" and "Quality Control Sample-Field Blank" values in the ActivityTypeCode field.
```{r}
TADAProfileClean13 <- dplyr::filter(TADAProfileClean12, !(ActivityTypeCode %in% c("Quality Control Sample-Field Replicate", "Quality Control Sample-Field Blank")))
```

We've completed our review of the ActivityTypeCode field. 

Let's move on to a different field and see if there are any values that we want to remove -- we'll look at the values in the ResultStatusIdentifier field.
```{r, echo=FALSE}
FilterFieldReview("ActivityMediaSubdivisionName", TADAProfileClean13)
```

The ActivityMediaSubdivisionName field has two unique values, "Surface Water" and "Groundwater." In this example we want to remove the "Groundwater" values. 
```{r}
TADAProfileClean14 <- dplyr::filter(TADAProfileClean13, !(ActivityMediaSubdivisionName %in% "Groundwater"))
```

## Filter data by field, subset by parameter
In this section a TADA user will want to select a parameter, review the unique values associated with that parameter in specific fields, and choose to remove particular values. 

To start, review the list of parameters in the dataset. (The list is sorted from highest to lowest counts. Only the first few rows are displayed to save space on the page) 
```{r, echo=FALSE}
FilterParList(TADAProfileClean14)
```

Next, select a parameter. Let's explore the fields associated with Nitrogen:
```{r, echo=FALSE}
FilterParFields(TADAProfileClean14, "NITROGEN")
```

Selecting a parameter generates the list below, which is subset by the selected parameter, of fields and the number of unique values in each field.

Then choose a field from the list. In this example we'll remove certain values from the HydrologicEvent field.
```{r, echo=FALSE}
FilterParFieldReview("HydrologicEvent", TADAProfileClean14, "NITROGEN")
```

The HydrologicEvent field has three unique values. In this example we want to remove samples collected during "Storm" events. Therefore, we'll specify that we want to remove rows where the CharacteristicName is "NITROGEN" and the HydrologicEvent field is "Storm." 
```{r}
TADAProfileClean15 <- dplyr::filter(TADAProfileClean14, !(CharacteristicName %in% "NITROGEN" & HydrologicEvent %in% "Storm"))
```

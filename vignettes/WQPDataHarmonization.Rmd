---
title: "WQP Data Harmonization"
author: "Cristina Mullin and Jake Greif"
date: "May 1, 2022"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{WQP Data Harmonization}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---
```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

##Install packages 
If needed (for example, if you are a new R user), install the following dependency package(s):
```{r}
#install.packages("dataRetrieval")
remotes::install_github("USGS-R/dataRetrieval")
install.packages("dplyr")
install.packages("ggplot2")
install.packages("plyr")
install.packages("RColorBrewer")
install.packages("Rcpp")
install.packages("data.table")
install.packages("grDevices")
install.packages("magrittr")
install.packages("stringr")
install.packages("testthat")
install.packages("usethis")
install.packages("utils")
install.packages("stats")
```

##Load packages
```{r}
library("dataRetrieval")
library("dplyr")
library("ggplot2")
library("plyr")
library("RColorBrewer")
library("Rcpp")
library("data.table")
library("grDevices")
library("magrittr")
library("stringr")
library("testthat")
library("usethis")
library("utils")
library("stats")
```

## Load TADA library and update internal TADA package validation and reference tables
```{r}
# look into using install_github(); library() only works for CRAN packages
remotes::install_github("USEPA/TADA")
UpdateWQXCharValRef()
UpdateMeasureUnitRef()
```

## Read in WQP data using WQP web services directly 

Go to the WQP website (https://www.waterqualitydata.us/) and fill out the 
query form. Choose the Full Physical Chemical Data Profile, all data sources, 
and the file format Comma-Separated. Do not hit the download button. Instead, 
copy the web service URL located at the bottom of the page under "Result". 

Use that "Result" web service URL as the input for this function to download data 
directly into R.  

Here are two "Result" web service examples: 

CT Nutrient Group: https://www.waterqualitydata.us/data/Result/search?statecode=US%3A09&countycode=US%3A09%3A003&characteristicType=Nutrient&mimeType=csv&zip=yes&dataProfile=resultPhysChem&providers=NWIS&providers=STEWARDS&providers=STORET

PA Nutrient Group: https://www.waterqualitydata.us/data/Result/search?statecode=US%3A42&characteristicType=Nutrient&mimeType=csv&zip=yes&dataProfile=resultPhysChem&providers=NWIS&providers=STEWARDS&providers=STORET

PA Lake Nutrient Data:
https://www.waterqualitydata.us/data/Result/search?statecode=US%3A42&siteType=Lake%2C%20Reservoir%2C%20Impoundment&sampleMedia=water&sampleMedia=Water&characteristicType=Nutrient&startDateLo=01-01-2019&startDateHi=01-01-2022&mimeType=csv&zip=yes&dataProfile=resultPhysChem&providers=NWIS&providers=STEWARDS&providers=STORET

Note: It may be useful to save the Query URL as well as a comment within 
your code. This URL let's you return to the WQP query page with all your 
original data filters, but it cannot be used to download the data.

WQP query URL: https://www.waterqualitydata.us/#statecode=US%3A42&characteristicType=Nutrient&mimeType=csv&dataProfile=resultPhysChem&providers=NWIS&providers=STEWARDS&providers=STORET

```{r}
FullPhysChem=readWQPwebservice("https://www.waterqualitydata.us/data/Result/search?statecode=US%3A42&characteristicType=Nutrient&mimeType=csv&zip=yes&dataProfile=resultPhysChem&providers=NWIS&providers=STEWARDS&providers=STORET")

# Transform data to uppercase where needed
FullPhysChem$CharacteristicName = toupper(FullPhysChem$CharacteristicName)
FullPhysChem$ResultSampleFractionText = toupper(FullPhysChem$ResultSampleFractionText)
FullPhysChem$MethodSpecificationName = toupper(FullPhysChem$MethodSpecificationName)
FullPhysChem$ResultMeasure.MeasureUnitCode = toupper(FullPhysChem$ResultMeasure.MeasureUnitCode)
FullPhysChem$ActivityMediaName = toupper(FullPhysChem$ActivityMediaName)
FullPhysChem$DetectionQuantitationLimitMeasure.MeasureUnitCode = toupper(FullPhysChem$DetectionQuantitationLimitMeasure.MeasureUnitCode)

# Remove duplicate rows
FullPhysChem=FullPhysChem[!duplicated(FullPhysChem),]

# Remove non-water media 
FullPhysChem=dplyr::filter(FullPhysChem, ActivityMediaName == "WATER")
```

## Clean raw data for TADA use case
```{r}
#Get testing data
  #stateCode = "US:24",
  #siteType = c("Lake, Reservoir, Impoundment", "Stream")
  #sampleMedia = c("water", "Water")
  #characteristicName = c("Ammonia", "Nitrate", "Nitrogen")
  #startDate = "01-01-2019"
  #endDate = "01-01-2022"
#autocleans results upon retrieval (makes certain data uppercase, removes true duplicates, removed non-water media)
TADATesting=TADAdataRetrieval()

#Run all dependencies
TADAProfileClean=MeasureValueSpecialCharacters(TADAProfileRaw)

TADAProfileClean2=DepthProfileData(TADAProfileClean)
TADAProfileClean3=AggregatedContinuousData(TADAProfileClean2)
TADAProfileClean4=WQXTargetUnits(TADAProfileClean3)
```

## Run result flag functions and address flagged data
```{r}
TADAProfileClean5=InvalidMethod(TADAProfileClean4)
TADAProfileClean6=PotentialDuplicateRowID(TADAProfileClean5)
TADAProfileClean7=AboveNationalWQXUpperThreshold(TADAProfileClean6)
TADAProfileClean8=BelowNationalWQXUpperThreshold(TADAProfileClean7)
TADAProfileClean9=QAPPapproved(TADAProfileClean8)
TADAProfileClean10=QAPPDocAvailable(TADAProfileClean8)
TADAProfileClean11=InvalidCoordinates(TADAProfileClean8)
TADAProfileClean12=InvalidFraction(TADAProfileClean8)
TADAProfileClean13=InvalidSpeciation(TADAProfileClean12)
TADAProfileClean14=InvalidResultUnit(TADAProfileClean13)
```

## Filter data by field
In this section a TADA user will want to review the unique values in specific fields and choose to remove particular values. 

To start, review the list of fields and the number of unique values in each field.
```{r, echo=FALSE}
FilterFields(TADAProfileClean14)
```

Next, choose a field from the list to see the unique values in that field, as well as the number of times each value appears in the dataset. We'll start with ActivityTypeCode.
```{r, echo=FALSE}
FilterFieldReview("ActivityTypeCode")
```

The ActivityTypeCode field has four unique values -- "Sample-Routine", "Quality Control Sample-Field Replicate", "Field Msr/Obs", and "Quality Control Sample-Field Blank." In this example we want to remove quality control values in the ActivityTypeCode field, therefore, we'll specify that we want to remove the "Quality Control Sample-Field Replicate" and "Quality Control Sample-Field Blank" values in the ActivityTypeCode field.
```{r}
TADAProfileClean15 <- dplyr::filter(TADAProfileClean14, !(ActivityTypeCode %in% c("Quality Control Sample-Field Replicate", "Quality Control Sample-Field Blank")))
```

We've completed our review of the ActivityTypeCode field. 

Let's move on to a different field and see if there are any values that we want to remove -- we'll look at the values in the ResultStatusIdentifier field.
```{r, echo=FALSE}
FilterFieldReview("ActivityMediaSubdivisionName")
```

The ActivityMediaSubdivisionName field has two unique values, "Surface Water" and "Groundwater." In this example we want to remove the "Groundwater" values. 
```{r}
TADAProfileClean16 <- dplyr::filter(TADAProfileClean15, !(ActivityMediaSubdivisionName %in% "Groundwater"))
```

## Filter data by field, subset by parameter
In this section a TADA user will want to select a parameter, review the unique values associated with that parameter in specific fields, and choose to remove particular values. 

To start, review the list of parameters in the dataset. (The list is sorted from highest to lowest counts. Only the first few rows are displayed to save space on the page) 
```{r, echo=FALSE}
FilterParList(TADAProfileClean16)
```

Next, select a parameter. Let's explore the fields associated with Nitrogen:
```{r, echo=FALSE}
FilterParFields(TADAProfileClean16, "NITROGEN")
```

Selecting a parameter generates the list below, which is subset by the selected parameter, of fields and the number of unique values in each field.

Then choose a field from the list. In this example we'll remove certain values from the HydrologicEvent field.
```{r, echo=FALSE}
FilterParFieldReview("HydrologicEvent")
```

The HydrologicEvent field has three unique values. In this example we want to remove samples collected during "Storm" events. Therefore, we'll specify that we want to remove rows where the CharacteristicName is "NITROGEN" and the HydrologicEvent field is "Storm." 
```{r}
TADAProfileClean17 <- dplyr::filter(TADAProfileClean16, !(CharacteristicName %in% "NITROGEN" & HydrologicEvent %in% "Storm"))
```

## Transform Characteristic, Speciation, and Unit values to TADA Standards
```{r}
UniqueHarmonizationRef=HarmonizationRefTable(TADAProfileClean17)
TADAProfileClean18=HarmonizeData(TADAProfileClean17, ref = UniqueHarmonizationRef)
```
